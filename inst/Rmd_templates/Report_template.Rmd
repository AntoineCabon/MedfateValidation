---
title: "Report for `r params$code`"
author: "medfateTeam"
date: "`r Sys.time()`"
params:
  wd: ''
  code: ''
  transpMode: 'both'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = params$wd)
library(medfate)
library(MedfateValidation)
library(dplyr)
```

```{r data, message=FALSE}
# site/plot code
code <- params$code

# raw data
treeData <- load_treeData(code)
shrubData <- load_shrubData(code)
seedData <- load_seedData(code)
customParams <- load_customParams(code)
measuredData <- load_measuredData(code)
meteoData <- load_meteoData(code)
miscData <- load_miscData(code)
soilData <- load_soilData(code)
terrainData <- load_terrainData(code)

# model objects
forest_object <- buildForest(treeData, shrubData, seedData, miscData)
soil_object <- buildSoil(soilData)

# SpParams
data('SpParamsMED', package = 'medfate')

# SpParams modifications (if any)
sp_params <- SpParams_mod(SpParamsMED, customParams)
```

# General Info

:
Package version: `r packageVersion('medfate')`  
Site: `r params$code`  



## *Simple* Model

```{r simple_model, eval=TRUE, message=FALSE}
# check if simple mode has to be performed
if (params$transpMode %in% c('simple', 'both')) {
  # control object
  control_obj <- medfate::defaultControl()
  control_obj$verbose <- FALSE
  control_obj$transpirationMode <- 'Simple'
  
  # input object
  simple_input <- medfate::forest2swbInput(forest_object, soil_object,
                                           sp_params, control_obj)
  
  # input modifications (if any)
  simple_input <- inputMod(simple_input, customParams)
  
  # model run
  res_simple <- medfate::swb(simple_input, soil_object, meteoData)
} else {
  # if simple mode is not performed, report about it
  cat('Simple model has not been selected to be performed')
}
```

```{r plot_simple, eval = TRUE, fig.height=8, fig.width=8}
# show the plot only if simple mode must be performed
if (params$transpMode %in% c('simple', 'both')) {
  # config layout
  par(mfrow = c(2,2))
  # P/PET plot
  plot(res_simple, yearAxis = TRUE)
  # ET plot
  plot(res_simple, type = 'ET', yearAxis = TRUE)
  # SWC plot
  plot(x = 1:nrow(meteoData),
       y = res_simple$SoilWaterBalance$W.1 * soil_object$Theta_FC[[1]],
       col = 'black', ylab = 'SWC', xlab = 'Days (absolute)')
  yts <- measuredData$SWC
  yse <- measuredData$SWC_err
  lines(x = 1:nrow(meteoData), y = yts, col = "red", lwd = 2)
  lines(x = 1:nrow(meteoData), y = yts + 1.96 * yse, col = "red", lwd = 1)
  lines(x = 1:nrow(meteoData), y = yts - 1.96 * yse, col = "red", lwd = 1)
  # Stress plot
  plot(res_simple, type = 'PlantStress', yearAxis = TRUE)
  # reset layout
  par(mfrow = c(1,1))
}
```

## *Complex* Model

```{r complex_model}
# check if complex mode has to be performed
if (params$transpMode %in% c('complex', 'both')) {
  # control object
  control_obj <- medfate::defaultControl()
  control_obj$verbose <- FALSE
  control_obj$transpirationMode <- 'Complex'
  
  # input object
  complex_input <- medfate::forest2swbInput(forest_object, soil_object,
                                            sp_params, control_obj)
  
  # input modifications (if any)
  complex_input <- inputMod(complex_input, customParams)
  
  # model run
  res_complex <- medfate::swb(complex_input, soil_object, meteoData,
                             terrainData$latitude, terrainData$elevation,
                             terrainData$slope, terrainData$aspect)
} else {
  # if simple mode is not performed, report about it
  cat('Complex model has not been selected to be performed')
}
```

```{r plot_complex, eval = TRUE, fig.height=8, fig.width=8}
# show the plot only if simple mode must be performed
if (params$transpMode %in% c('complex', 'both')) {
  # config layout
  par(mfrow = c(2,2))
  # P/PET plot
  plot(res_complex, yearAxis = TRUE)
  # ET plot
  plot(res_complex, type = 'ET', yearAxis = TRUE)
  # SWC plot
  plot(x = 1:nrow(meteoData),
       y = res_complex$SoilWaterBalance$W.1 * soil_object$Theta_FC[[1]],
       col = 'black', ylab = 'SWC', xlab = 'Days (absolute)')
  yts <- measuredData$SWC
  yse <- measuredData$SWC_err
  lines(x = 1:nrow(meteoData), y = yts, col = "red", lwd = 2)
  lines(x = 1:nrow(meteoData), y = yts + 1.96 * yse, col = "red", lwd = 1)
  lines(x = 1:nrow(meteoData), y = yts - 1.96 * yse, col = "red", lwd = 1)
  # Stress plot
  plot(res_complex, type = 'PlantStress', yearAxis = TRUE)
  # reset layout
  par(mfrow = c(1,1))
}
```

```{r saving_txt_results}
if (params$transpMode %in% c('both')) {
  sp_names <- paste0('E_sp', simple_input$above$SP)
  models_dfs <- saveRes(res_simple, res_complex, spParams = sp_params,
                        site_code = params$code)
} else {
  if (params$transpMode %in% c('simple')) {
    sp_names <- paste0('E_sp', simple_input$above$SP)
    models_dfs <- saveRes(res_simple, spParams = sp_params,
                          site_code = params$code)
  } else {
    sp_names <- paste0('E_sp', complex_input$above$SP)
    models_dfs <- saveRes(complex_res = res_complex,
                          spParams = sp_params, site_code = params$code)
  }
}
```

## Models comparision

### SWC in the first layer

```{r statistics_SWC}
SWC_stats <- statistics_summary('SWC', models_dfs, measuredData,
                                soil_object)
```

Comparision | MAE | r² | Bias
------------|-----|----|-------
Simple *vs.* Measured | `r SWC_stats$SWC_MAE_simple` | `r SWC_stats$SWC_r_sq_simple` | `r SWC_stats$SWC_bias_simple`
Complex *vs.* Measured | `r SWC_stats$SWC_MAE_complex` | `r SWC_stats$SWC_r_sq_complex` | `r SWC_stats$SWC_bias_complex`
Simple *vs.* Complex | `r SWC_stats$SWC_MAE_both` | `r SWC_stats$SWC_r_sq_both` | `r SWC_stats$SWC_bias_both`


```{r plots_SWC, fig.height=6, fig.width=8, eval = TRUE}
par(mfrow = c(2,3))

plot(models_dfs[['simple']][['Dates']],
     models_dfs[['simple']][['W.1']] * soil_object$Theta_FC[[1]],
     col = 'blue', ylab = 'SWC', xlab = 'Date',
     main = 'Simple vs. Measured')
lines(models_dfs[['simple']][['Dates']],
      measuredData[['SWC']], col = 'red', lwd = 2)

plot(models_dfs[['complex']][['Dates']],
     models_dfs[['complex']][['W.1']] * soil_object$Theta_FC[[1]],
     col = 'green', ylab = 'SWC', xlab = 'Date',
     main = 'Complex vs. Measured')
lines(models_dfs[['complex']][['Dates']],
      measuredData[['SWC']], col = 'red', lwd = 2)

plot(models_dfs[['simple']][['Dates']],
     models_dfs[['simple']][['W.1']] * soil_object$Theta_FC[[1]],
     col = 'blue', ylab = 'SWC', xlab = 'Date', type = 'n',
     main = 'Simple vs. Complex')
lines(models_dfs[['complex']][['Dates']],
      models_dfs[['complex']][['W.1']] * soil_object$Theta_FC[[1]],
      col = 'green', lwd = 2)
lines(models_dfs[['simple']][['Dates']],
      models_dfs[['simple']][['W.1']] * soil_object$Theta_FC[[1]],
      col = 'blue', lwd = 2)

plot(models_dfs[['simple']][['W.1']] * soil_object$Theta_FC[[1]],
     measuredData[['SWC']], pch = 20, xlab = 'Simple', ylab = 'Measured')

plot(models_dfs[['complex']][['W.1']] * soil_object$Theta_FC[[1]],
     measuredData[['SWC']], pch = 20, xlab = 'Complex', ylab = 'Measured')

plot(models_dfs[['simple']][['W.1']] * soil_object$Theta_FC[[1]],
     models_dfs[['complex']][['W.1']] * soil_object$Theta_FC[[1]],
     pch = 20, xlab = 'Simple', ylab = 'Complex')

# reset layout
par(mfrow = c(1,1))
```

### Total Tranpiration

```{r statistics_Eplanttot}
Eplanttot_stats <- statistics_summary('Eplanttot', models_dfs, measuredData,
                                      soil_object)
```

Comparision | MAE | r² | Bias
------------|-----|----|-------
Simple *vs.* Measured | `r Eplanttot_stats$Eplanttot_MAE_simple` | `r Eplanttot_stats$Eplanttot_r_sq_simple` | `r Eplanttot_stats$Eplanttot_bias_simple`
Complex *vs.* Measured | `r Eplanttot_stats$Eplanttot_MAE_complex` | `r Eplanttot_stats$planttot_r_sq_complex` | `r Eplanttot_stats$Eplanttot_bias_complex`
Simple *vs.* Complex | `r Eplanttot_stats$Eplanttot_MAE_both` | `r Eplanttot_stats$Eplanttot_r_sq_both` | `r Eplanttot_stats$Eplanttot_bias_both`


```{r plots_Eplanttot, fig.height=8, fig.width=8}
par(mfrow = c(2,3))

plot(models_dfs[['simple']][['Dates']],
     models_dfs[['simple']][['Eplanttot']],
     col = 'blue', ylab = 'SWC', xlab = 'Date',
     main = 'Simple vs. Measured')
lines(models_dfs[['simple']][['Dates']],
      measuredData[['Eplanttot']], col = 'red', lwd = 2)

plot(models_dfs[['complex']][['Dates']],
     models_dfs[['complex']][['Eplanttot']],
     col = 'green', ylab = 'Eplanttot', xlab = 'Date',
     main = 'Complex vs. Measured')
lines(models_dfs[['complex']][['Dates']],
      measuredData[['Eplanttot']], col = 'red', lwd = 2)

plot(models_dfs[['simple']][['Dates']],
     models_dfs[['simple']][['Eplanttot']],
     col = 'blue', ylab = 'Eplanttot', xlab = 'Date', type = 'l',
     main = 'Simple vs. Complex')
lines(models_dfs[['complex']][['Dates']],
      models_dfs[['complex']][['Eplanttot']],
      col = 'green', lwd = 2)

plot(models_dfs[['simple']][['Eplanttot']],
     measuredData[['Eplanttot']], pch = 21, xlab = 'Simple', ylab = 'Measured')

plot(models_dfs[['complex']][['Eplanttot']],
     measuredData[['Eplanttot']], pch = 21, xlab = 'Complex', ylab = 'Measured')

plot(models_dfs[['simple']][['Eplanttot']],
     models_dfs[['complex']][['Eplanttot']],
     pch = 21, xlab = 'Simple', ylab = 'Complex')

# reset layout
par(mfrow = c(1,1))
```

### Transpiration by cohorts

```{r statistics_E_cohorts, results='asis'}
Ecohorts_stats <- statistics_summary('E_by_Cohort', models_dfs, measuredData,
                                     soil_object)

rbind(
  round(Ecohorts_stats[["Esp_MAE_simple"]], 5),
  round(Ecohorts_stats[["Esp_r_sq_simple"]], 5),
  round(Ecohorts_stats[["Esp_bias_simple"]], 5),
  round(Ecohorts_stats[["Esp_MAE_complex"]], 5),
  round(Ecohorts_stats[["Esp_r_sq_complex"]], 5),
  round(Ecohorts_stats[["Esp_bias_complex"]], 5),
  round(Ecohorts_stats[["Esp_MAE_both"]], 5),
  round(Ecohorts_stats[["Esp_r_sq_both"]], 5),
  round(Ecohorts_stats[["Esp_bias_both"]], 5)
) %>%
  cbind(
    c('MAE Simple vs. Measured',
      'rsq Simple vs. Measured',
      'Bias Simple vs. Measured',
      'MAE Complex vs. Measured',  
      'rsq Complex vs. Measured',  
      'Bias Complex vs. Measured',
      'MAE Simple vs. Complex',
      'rsq Simple vs. Complex',
      'Bias Simple vs. Complex'),
    .
  ) %>%
  as.data.frame() %>%
  xtable::xtable()
```
