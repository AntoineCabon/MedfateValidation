---
title: "Report for `r params$code`"
author: "medfateTeam"
date: "`r Sys.time()`"
params:
  wd: ''
  code: ''
  transpMode: ''
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = params$wd)
library(medfate)
library(MedfateValidation)
```

```{r data, message=FALSE}
# data
code <- params$code

treeData <- load_treeData(code)
shrubData <- load_shrubData(code)
seedData <- load_seedData(code)
customParams <- load_customParams(code)
measuredData <- load_measuredData(code)
meteoData <- load_meteoData(code)
miscData <- load_miscData(code)
soilData <- load_soilData(code)
terrainData <- load_terrainData(code)

forest_object <- buildForest(treeData, shrubData, seedData, miscData)
soil_object <- buildSoil(soilData)

data('SpParamsMED', package = 'medfate')
```


## *Simple* Model

```{r simple_model, eval=TRUE, message=FALSE}
# check if simple mode has to be performed
if (params$transpMode %in% c('simple', 'both')) {
  # control object
  control_obj <- medfate::defaultControl()
  control_obj$verbose <- FALSE
  control_obj$transpirationMode <- 'Simple'
  
  # input object
  simple_input <- medfate::forest2swbInput(forest_object, soil_object, SpParamsMED,
                                           medfate::control_obj)
  
  # model run
  res_simple <- medfate::swb(simple_input, soil_object, meteoData)
} else {
  # if simple mode is not performed, inform about it in the report
  cat('Simple model has not been selected to be performed')
}
```

```{r plot, eval = TRUE, fig.height=12}
# show the plot only if simple mode must be performed
if (params$transpMode %in% c('simple', 'both')) {
  # config layout
  par(mfrow = c(4,1))
  # P/PET plot
  plot(res_simple, yearAxis = TRUE)
  # ET plot
  plot(res_simple, type = 'ET', yearAxis = TRUE)
  # SWC plot
  plot(x = 1:nrow(meteoData),
     y = res_simple$SoilWaterBalance$W.1 * soil_object$Theta_FC[[1]],
     col = 'black')
  yts <- measuredData$SWC
  yse <- measuredData$SWC_err
  lines(x = 1:nrow(meteoData), y = yts, col = "red", lwd = 2)
  lines(x = 1:nrow(meteoData), y = yts + 1.96 * yse, col = "red", lwd = 1)
  lines(x = 1:nrow(meteoData), y = yts - 1.96 * yse, col = "red", lwd = 1)
  # Stress plot
  plot(res_simple, type = 'PlantStress', yearAxis = TRUE)
  # reset layout
  par(mfrow = c(1,1))
}
```
